# =====[ Plugins ]=====
## Initialize Plug.kak
source "%val{config}/plugins/plug.kak/rc/plug.kak"

## Language Server
eval %sh{kak-lsp --kakoune -s ${kak_session}}
lsp-enable

lsp auto-signature-help-disable

### Use tab to cycle through suggestions
hook global InsertCompletionShow .* %{
    try %{
        # this command temporarily removes cursors preceded by whitespace;
        # if there are no cursors left, it raises an error, does not
        # continue to execute the mapping commands, and the error is eaten
        # by the `try` command so no warning appears.
        execute-keys -draft "h<a-K>\h<ret>"
        map window insert <tab> <c-n>
        map window insert <s-tab> <c-p>
    }
}

### Undo mappings from above when suggestions go away
hook global InsertCompletionHide .* %{
    unmap window insert <tab> <c-n>
    unmap window insert <s-tab> <c-p>
}

# =====[ Visual ]=====

## Assistant
set-option global ui_options "ncurses_assistant=cat"

## Theme
colorscheme base16-material-palenight

## Relative line numbers
add-highlighter global/ number-lines -relative -hlcursor -min-digits 3

## Render matching braces as "MatchingChar" face 
add-highlighter global/ show-matching

## Render whitespace
### Render whitespace same as Line Numbers, but dimmer
face global Whitespace +d@LineNumbers
add-highlighter global/ show-whitespaces

# =====[ Key Bindings ]=====
## --- User Mode ---
map global user y "<a-|>xclip -i -selection clipboard<ret>" -docstring "yank current selection to system clipboard"
map global user h ":lsp-hover<ret>" -docstring "trigger language server hover"

map global user < "bi<lt><esc>a<gt><esc>m" \
    -docstring "wrap current selection with angles <<sel>>"

map global user o ",<lt>iOption<esc>B<a-:>" \
    -docstring "wrap current selection with Option<<sel>>"

map global user r ",<lt>iResult<esc>wa, Error<esc>;b<a-:>" \
    -docstring "wrap current selection with Result<<sel>, E>"

### if user mode gets fatter, consider making this <a-l>
map global user l "i[<esc>a ðŸ”—]<esc>m<a-:>" \
    -docstring "surround current selection with markdown-style link + link emoji"

## --- Insert Mode ---
### Use j-k to exit
hook global InsertChar k %{ try %{
  exec -draft hH <a-k>jk<ret> d
  exec <esc>
}}

## "SmartTab"
plug "andreyorst/smarttab.kak"

### Tab behavior
hook global ModuleLoaded smarttab %{
    set-option global softtabstop 4 # tab = 4 spaces
}

# always use spaces
hook global WinSetOption .* expandtab
